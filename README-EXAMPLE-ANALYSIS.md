# README.md Example Analysis & Verification Guide

## ?? Overview

This document provides a detailed analysis of the README.md Complete Example and verification steps to ensure your implementation matches the specification exactly.

---

## ?? Key Observations from README.md Example

### 1. ? Tenant ID Format
- **Value:** `"tenant001"` (no dashes)
- **Note:** Different from typical UUID format
- **Validation:** Must match pattern `^[a-z0-9]+(?:_[a-z0-9]+)*$`

### 2. ? Mutation IDs
- All use UUID format with dashes
- Examples:
  - `a1111111-1111-1111-1111-111111111111`
  - `b4444444-4444-4444-4444-444444444444`
  - `c5555555-5555-5555-5555-555555555555`

### 3. ? Date Format
- **Format:** `YYYY-MM-DD`
- **Examples:**
  - `"2020-01-01"`
  - `"2021-01-01"`
  - `"1960-06-15"`

### 4. ? Calculation Verification

**Indexation Calculation:**
```
Initial salary: 50000
Percentage: 0.03 (3%)
Formula: 50000 * (1 + 0.03) = 50000 * 1.03
Result: 51500 ?
```

**Policy ID Generation:**
```
Format: {dossier_id}-{sequence}
dossier_id: d2222222-2222-2222-2222-222222222222
sequence: 1 (first policy)
Result: d2222222-2222-2222-2222-222222222222-1 ?
```

---

## ?? Request Structure Analysis

### Complete Request (test-readme-example.json)

```json
{
  "tenant_id": "tenant001",
  "calculation_instructions": {
    "mutations": [
      {
        "mutation_id": "a1111111-1111-1111-1111-111111111111",
        "mutation_definition_name": "create_dossier",
        "mutation_type": "DOSSIER_CREATION",
        "actual_at": "2020-01-01",
        "mutation_properties": {
          "dossier_id": "d2222222-2222-2222-2222-222222222222",
          "person_id": "p3333333-3333-3333-3333-333333333333",
          "name": "Jane Doe",
          "birth_date": "1960-06-15"
        }
      },
      {
        "mutation_id": "b4444444-4444-4444-4444-444444444444",
        "mutation_definition_name": "add_policy",
        "mutation_type": "DOSSIER",
        "actual_at": "2020-01-01",
        "dossier_id": "d2222222-2222-2222-2222-222222222222",
        "mutation_properties": {
          "scheme_id": "SCHEME-A",
          "employment_start_date": "2000-01-01",
          "salary": 50000,
          "part_time_factor": 1.0
        }
      },
      {
        "mutation_id": "c5555555-5555-5555-5555-555555555555",
        "mutation_definition_name": "apply_indexation",
        "mutation_type": "DOSSIER",
        "actual_at": "2021-01-01",
        "dossier_id": "d2222222-2222-2222-2222-222222222222",
        "mutation_properties": {
          "percentage": 0.03
        }
      }
    ]
  }
}
```

### Request Breakdown by Mutation

#### Mutation 1: create_dossier
- **Type:** DOSSIER_CREATION
- **Creates:**
  - Dossier with ID: `d2222222-2222-2222-2222-222222222222`
  - Person with ID: `p3333333-3333-3333-3333-333333333333`
  - Name: "Jane Doe"
  - Birth date: 1960-06-15
- **State after:**
  - Dossier status: ACTIVE
  - Retirement date: null
  - Persons: [Jane Doe]
  - Policies: []

#### Mutation 2: add_policy
- **Type:** DOSSIER
- **Adds:**
  - Policy to dossier `d2222222-2222-2222-2222-222222222222`
  - Scheme: SCHEME-A
  - Employment start: 2000-01-01
  - Salary: 50000
  - Part-time factor: 1.0 (full-time)
- **Auto-generated:**
  - Policy ID: `d2222222-2222-2222-2222-222222222222-1`
- **State after:**
  - Policies: [Policy with salary 50000]

#### Mutation 3: apply_indexation
- **Type:** DOSSIER
- **Applies:**
  - 3% increase (percentage: 0.03)
  - No filters (applies to all policies)
- **Calculation:**
  - Old salary: 50000
  - New salary: 50000 * 1.03 = 51500
- **State after:**
  - Policies: [Policy with salary 51500]

---

## ?? Expected Response Structure Analysis

### Metadata Section

```json
"calculation_metadata": {
  "calculation_id": "<UUID v4>",
  "tenant_id": "tenant001",
  "calculation_started_at": "<ISO 8601 timestamp>",
  "calculation_completed_at": "<ISO 8601 timestamp>",
  "calculation_duration_ms": <integer>,
  "calculation_outcome": "SUCCESS"
}
```

**Key Points:**
- ? `calculation_id` must be a new UUID v4 generated by engine
- ? `tenant_id` must match request (`"tenant001"`)
- ? Timestamps must be ISO 8601 format
- ? `calculation_duration_ms` must be actual duration
- ? `calculation_outcome` must be `"SUCCESS"` (no errors in this scenario)

---

### Messages Section

```json
"messages": []
```

**Key Points:**
- ? Empty array (no validation errors or warnings)
- ?? Note: Empty array `[]`, not `null`

---

### Initial Situation Section

```json
"initial_situation": {
  "actual_at": "2020-01-01",
  "situation": {
    "dossier": null
  }
}
```

**Key Points:**
- ? `actual_at` = first mutation's `actual_at` (2020-01-01)
- ? `dossier` = `null` (no dossier before first mutation)
- ?? Note: Does NOT include `mutation_id` or `mutation_index` fields

---

### Mutations Section

**Structure per mutation:**
```json
{
  "mutation": { 
    /* Original mutation object from request */
  }
  /* No calculation_message_indexes field when no messages */
}
```

**Key Points:**
- ? Each entry contains the original mutation object
- ? `mutation_properties` must be present with original values
- ? No `calculation_message_indexes` field when there are no messages
- ?? mutation_properties values must NOT be JsonElement wrappers

**Mutation 1 in response:**
```json
{
  "mutation": {
    "mutation_id": "a1111111-1111-1111-1111-111111111111",
    "mutation_definition_name": "create_dossier",
    "mutation_type": "DOSSIER_CREATION",
    "actual_at": "2020-01-01",
    "mutation_properties": {
      "dossier_id": "d2222222-2222-2222-2222-222222222222",
      "person_id": "p3333333-3333-3333-3333-333333333333",
      "name": "Jane Doe",
      "birth_date": "1960-06-15"
    }
  }
}
```

**Mutation 2 in response:**
```json
{
  "mutation": {
    "mutation_id": "b4444444-4444-4444-4444-444444444444",
    "mutation_definition_name": "add_policy",
    "mutation_type": "DOSSIER",
    "actual_at": "2020-01-01",
    "dossier_id": "d2222222-2222-2222-2222-222222222222",
    "mutation_properties": {
      "scheme_id": "SCHEME-A",
      "employment_start_date": "2000-01-01",
      "salary": 50000,
      "part_time_factor": 1.0
    }
  }
}
```

**Mutation 3 in response:**
```json
{
  "mutation": {
    "mutation_id": "c5555555-5555-5555-5555-555555555555",
    "mutation_definition_name": "apply_indexation",
    "mutation_type": "DOSSIER",
    "actual_at": "2021-01-01",
    "dossier_id": "d2222222-2222-2222-2222-222222222222",
    "mutation_properties": {
      "percentage": 0.03
    }
  }
}
```

---

### End Situation Section

```json
"end_situation": {
  "mutation_id": "c5555555-5555-5555-5555-555555555555",
  "mutation_index": 2,
  "actual_at": "2021-01-01",
  "situation": {
    "dossier": { ... }
  }
}
```

**Key Points:**
- ? `mutation_id` = last mutation's ID
- ? `mutation_index` = 2 (0-based: mutation 1=0, 2=1, 3=2)
- ? `actual_at` = last mutation's actual_at (2021-01-01)
- ? `situation` contains the final dossier state

---

### End Situation - Dossier State

```json
"dossier": {
  "dossier_id": "d2222222-2222-2222-2222-222222222222",
  "status": "ACTIVE",
  "retirement_date": null,
  "persons": [ ... ],
  "policies": [ ... ]
}
```

**Key Points:**
- ? `dossier_id` matches the created dossier
- ? `status` = "ACTIVE" (no retirement calculated yet)
- ? `retirement_date` = null (no retirement yet)

---

### End Situation - Persons Array

```json
"persons": [
  {
    "person_id": "p3333333-3333-3333-3333-333333333333",
    "role": "PARTICIPANT",
    "name": "Jane Doe",
    "birth_date": "1960-06-15"
  }
]
```

**Key Points:**
- ? Contains exactly one person (the participant)
- ? All values match the create_dossier mutation
- ? `role` = "PARTICIPANT" (always)

---

### End Situation - Policies Array

```json
"policies": [
  {
    "policy_id": "d2222222-2222-2222-2222-222222222222-1",
    "scheme_id": "SCHEME-A",
    "employment_start_date": "2000-01-01",
    "salary": 51500,
    "part_time_factor": 1.0,
    "attainable_pension": null,
    "projections": null
  }
]
```

**Key Points:**
- ? `policy_id` = `{dossier_id}-1` (auto-generated)
- ? `scheme_id` = "SCHEME-A" (from add_policy)
- ? `employment_start_date` = "2000-01-01" (from add_policy)
- ? `salary` = 51500 (after 3% indexation: 50000 * 1.03)
- ? `part_time_factor` = 1.0 (unchanged)
- ? `attainable_pension` = null (no retirement calculated)
- ? `projections` = null (no projections calculated)

---

## ? Verification Checklist

Use this checklist to verify your actual response against the expected response:

### Metadata
- [ ] calculation_id is a valid UUID v4
- [ ] tenant_id = "tenant001"
- [ ] calculation_started_at is ISO 8601 format
- [ ] calculation_completed_at is ISO 8601 format
- [ ] calculation_duration_ms is a positive integer
- [ ] calculation_outcome = "SUCCESS"

### Messages
- [ ] messages = [] (empty array)

### Initial Situation
- [ ] actual_at = "2020-01-01"
- [ ] situation.dossier = null
- [ ] No mutation_id field
- [ ] No mutation_index field

### Mutations Array
- [ ] Contains exactly 3 mutations
- [ ] Each has a "mutation" object
- [ ] No calculation_message_indexes field (or null)
- [ ] mutation_properties contain original values (not JsonElement)

### Mutation 1 (create_dossier)
- [ ] mutation_id = "a1111111-1111-1111-1111-111111111111"
- [ ] mutation_type = "DOSSIER_CREATION"
- [ ] actual_at = "2020-01-01"
- [ ] mutation_properties.dossier_id = "d2222222-2222-2222-2222-222222222222"
- [ ] mutation_properties.person_id = "p3333333-3333-3333-3333-333333333333"
- [ ] mutation_properties.name = "Jane Doe"
- [ ] mutation_properties.birth_date = "1960-06-15"
- [ ] NO dossier_id field at mutation level

### Mutation 2 (add_policy)
- [ ] mutation_id = "b4444444-4444-4444-4444-444444444444"
- [ ] mutation_type = "DOSSIER"
- [ ] actual_at = "2020-01-01"
- [ ] dossier_id = "d2222222-2222-2222-2222-222222222222"
- [ ] mutation_properties.scheme_id = "SCHEME-A"
- [ ] mutation_properties.employment_start_date = "2000-01-01"
- [ ] mutation_properties.salary = 50000
- [ ] mutation_properties.part_time_factor = 1.0

### Mutation 3 (apply_indexation)
- [ ] mutation_id = "c5555555-5555-5555-5555-555555555555"
- [ ] mutation_type = "DOSSIER"
- [ ] actual_at = "2021-01-01"
- [ ] dossier_id = "d2222222-2222-2222-2222-222222222222"
- [ ] mutation_properties.percentage = 0.03

### End Situation
- [ ] mutation_id = "c5555555-5555-5555-5555-555555555555"
- [ ] mutation_index = 2
- [ ] actual_at = "2021-01-01"

### End Situation - Dossier
- [ ] dossier_id = "d2222222-2222-2222-2222-222222222222"
- [ ] status = "ACTIVE"
- [ ] retirement_date = null

### End Situation - Person
- [ ] person_id = "p3333333-3333-3333-3333-333333333333"
- [ ] role = "PARTICIPANT"
- [ ] name = "Jane Doe"
- [ ] birth_date = "1960-06-15"

### End Situation - Policy
- [ ] policy_id = "d2222222-2222-2222-2222-222222222222-1"
- [ ] scheme_id = "SCHEME-A"
- [ ] employment_start_date = "2000-01-01"
- [ ] salary = 51500 (exactly)
- [ ] part_time_factor = 1.0
- [ ] attainable_pension = null
- [ ] projections = null

---

## ?? Testing Commands

### Run the API locally
```bash
cd HackatonAPI
dotnet run
```

### Send test request (curl)
```bash
curl -X POST http://localhost:5000/calculation-requests \
  -H "Content-Type: application/json" \
  -d @test-readme-example.json \
  | jq . > actual-response.json
```

### Send test request (PowerShell)
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:5000/calculation-requests" `
  -Method Post `
  -ContentType "application/json" `
  -Body (Get-Content test-readme-example.json -Raw)

$response | ConvertTo-Json -Depth 10 | Out-File actual-response.json
```

### Compare responses (manual)
```bash
# Use a JSON diff tool
diff expected-readme-response.json actual-response.json

# Or use jq to pretty-print both
jq . expected-readme-response.json > expected-formatted.json
jq . actual-response.json > actual-formatted.json
diff expected-formatted.json actual-formatted.json
```

---

## ?? Common Issues to Watch For

### 1. Tenant ID Format
- ? Wrong: `"tenant-001"` (with dashes)
- ? Correct: `"tenant001"` (no dashes)

### 2. Salary Precision
- ? Wrong: `51500.0` or `51500.00` (might be rejected by strict validators)
- ? Correct: `51500` (integer when no decimals)
- ? Also OK: `51500.0` (JSON allows both)

### 3. Empty Arrays vs Null
- ? Wrong: `"messages": null`
- ? Correct: `"messages": []`

### 4. mutation_properties Values
- ? Wrong: JsonElement wrappers or string representations
- ? Correct: Actual primitive values (strings, numbers, etc.)

### 5. Null Fields
- ?? Depends on spec: Some fields might need to be omitted vs set to null
- Common fields that are null in this example:
  - `retirement_date`
  - `attainable_pension`
  - `projections`

---

## ?? Files Created

- `test-readme-example.json` - Exact request from README
- `expected-readme-response.json` - Expected response template
- `README-EXAMPLE-ANALYSIS.md` - This document

---

## ? Summary

The README.md example is now:
- ? Analyzed in detail
- ? Request file created (test-readme-example.json)
- ? Expected response template created
- ? Verification checklist provided
- ? Testing commands documented

Use this guide to verify your implementation produces the exact output specified in the README.md!
